## 3.7 成块数据流

考虑使用ftp协议下载一个超大文件,在kevin上启动一个vsftpd服务器程序（升级的、安全版的ftp服务器程序），并执行ftp命令登录该服务器上，然后在ftp命令提示符后输入get命令，从服务器下载一个几百兆的大文件。

* 在kevin主机执行:
``````shell
$sudo tcpdump-nt-i eth0 port 20#vsftpd服务器程序使用端口号20 $ftp 127.0.0.1
Connected to 127.0.0.1.
220(vsFTPd 2.3.0)
Name(127.0.0.1:ernest):ernest（回车）#输入用户名并回车
331 Please specify the password.
Password:（回车）#输入密码并回车
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp＞get bigfile（回车）#获取大文件bigfile
``````

* 查看输出
``````shell
1.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[.],seq
205783041:205799425,ack 1,win 513,length 16384

2.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[.],seq
205799425:205815809,ack 1,win 513,length 16384

3.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[.],seq
205815809:205832193,ack 1,win 513,length 16384

4.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[P.],seq
205832193:205848577,ack 1,win 513,length 16384

5.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[.],seq
205848577:205864961,ack 1,win 513,length 16384

6.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[.],seq
205864961:205881345,ack 1,win 513,length 16384

7.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[.],seq
205881345:205897729,ack 1,win 513,length 16384

8.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[P.],seq
205897729:205914113,ack 1,win 513,length 16384

9.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[.],seq
205914113:205930497,ack 1,win 513,length 16384

10.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[.],seq
205930497:205946881,ack 1,win 513,length 16384

11.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[.],seq
205946881:205963265,ack 1,win 513,length 16384

12.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[P.],seq
205963265:205979649,ack 1,win 513,length 16384

13.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[.],seq
205979649:205996033,ack 1,win 513,length 16384

14.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[.],seq
205996033:206012417,ack 1,win 513,length 16384

15.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[.],seq
206012417:206028801,ack 1,win 513,length 16384

16.IP 127.0.0.1.20＞127.0.0.1.39651:Flags[P.],seq
206028801:206045185,ack 1,win 513,length 16384

17.IP 127.0.0.1.39651＞127.0.0.1.20:Flags[.],ack 205815809,win
30084,length 0

18.IP 127.0.0.1.39651＞127.0.0.1.20:Flags[.],ack 206045185,win
27317,leng
``````
**注:`** 报文段 17和18分别是对报文段2和16的确认(根据确认值和序号值推断)

* 当传输大量大块数据的时候，发送方会连续发送多个TCP报文段，接收方可以一次确认所有这些报文段。

Q: 那么发送方在收到上一次确认后，能连续发送多少个TCP报文段呢？

A:这是由接收通告窗口（还需要考虑
拥塞窗口，见后文）的大小决定的。TCP报文段17说明客户端还能接
收30 084×64字节（本例中窗口扩大因子为6），即1 925 376字节的数
据。而在TCP报文段18中，接收通告窗口大小为1 748 288字节，即客
户端能接收的数据量变小了。这表明客户端的TCP接收缓冲区有更多
的数据未被应用程序读取而停留在其中，这些数据都来自TCP报文段3
～16中的一部分。服务器收到TCP报文段18后，它至少（因为接收通
告窗口可能扩大）还能连续发送的未被确认的报文段数量是1 748
288/16 384个，即106个（但一般不会连续发送这么多）。其中，16
384是成块数据的长度（见TCP报文段1～16的length值），很显然它小
于但接近MSS规定的16 396字节